<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRYPTA - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a, #3730a3, #000);
            min-height: 100vh;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .user-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .verification-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="text-white p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">üîê CRYPTA - Admin Dashboard</h1>
            <p class="text-gray-300">Complete management system with manual task verification</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="stat-card rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-purple-400" id="totalUsers">0</div>
                <div class="text-gray-300">Total Users</div>
            </div>
            <div class="stat-card rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-blue-400" id="totalPoints">0</div>
                <div class="text-gray-300">Total Points</div>
            </div>
            <div class="stat-card rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-green-400" id="totalReferrals">0</div>
                <div class="text-gray-300">Total Referrals</div>
            </div>
            <div class="stat-card rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-yellow-400" id="totalTasks">0</div>
                <div class="text-gray-300">Completed Tasks</div>
            </div>
            <div class="stat-card rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-orange-400" id="pendingVerifications">0</div>
                <div class="text-gray-300">Pending Tasks</div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-4 mb-6 flex-wrap">
            <button onclick="loadData()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition">
                üîÑ Refresh Data
            </button>
            <a href="/api/admin/export-csv" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition no-underline text-white">
                üì• Export CSV with Emails
            </a>
            <button onclick="showPendingVerifications()" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg transition">
                ‚è≥ Pending Verifications (<span id="pendingCount">0</span>)
            </button>
            <button onclick="showAllUsers()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition">
                üë• All Users
            </button>
            <a href="/" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg transition no-underline text-white">
                üè† User Dashboard
            </a>
        </div>

        <!-- Pending Verifications Section -->
        <div id="pendingSection" class="user-card rounded-xl p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold mb-4">‚è≥ Pending Task Verifications</h2>
            <div id="pendingVerificationsList" class="space-y-4">
                <!-- Pending verifications will be injected here -->
            </div>
        </div>

        <!-- Users Table -->
        <div id="usersSection" class="user-card rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üë• All Users - Leaderboard</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-600">
                            <th class="text-left p-3">Rank</th>
                            <th class="text-left p-3">Username</th>
                            <th class="text-left p-3">Email</th>
                            <th class="text-left p-3">Telegram</th>
                            <th class="text-left p-3">Total Points</th>
                            <th class="text-left p-3">Task Points</th>
                            <th class="text-left p-3">Referral Points</th>
                            <th class="text-left p-3">Referrals</th>
                            <th class="text-left p-3">Completed Tasks</th>
                            <th class="text-left p-3">Pending Tasks</th>
                            <th class="text-left p-3">Registration Date</th>
                            <th class="text-left p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- Users data will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Details Modal -->
        <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-gray-800 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="modalTitle">User Details</h3>
                    <button onclick="closeUserModal()" class="text-gray-400 hover:text-white">‚úï</button>
                </div>
                <div id="modalContent">
                    <!-- Modal content will be injected here -->
                </div>
            </div>
        </div>

        <!-- Last Update -->
        <div class="text-center mt-8 text-gray-400">
            <div>Last update: <span id="lastUpdate">-</span></div>
            <div class="text-sm">Auto-refresh every 30 seconds</div>
        </div>
    </div>

    <script>
        const API_URL = '/api/referral';
        const ADMIN_URL = '/api/admin';

        async function loadData() {
            try {
                const response = await fetch(`${ADMIN_URL}/data`);
                const data = await response.json();
                
                if (data.success) {
                    // Update stats
                    document.getElementById('totalUsers').textContent = data.data.total_users;
                    document.getElementById('totalPoints').textContent = data.data.total_points;
                    document.getElementById('totalReferrals').textContent = data.data.total_referrals;
                    document.getElementById('totalTasks').textContent = data.data.total_completed_tasks;
                    document.getElementById('pendingVerifications').textContent = data.data.pending_verifications;
                    document.getElementById('pendingCount').textContent = data.data.pending_verifications;
                    
                    // Update users table
                    updateUsersTable(data.data.users);
                    
                    // Update timestamp
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data');
            }
        }

        function updateUsersTable(users) {
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = '';

            users.forEach((user, index) => {
                const userRow = `
                    <tr class="border-b border-gray-700 hover:bg-gray-800">
                        <td class="p-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold ${
                                index === 0 ? 'bg-yellow-500 text-black' : 
                                index === 1 ? 'bg-gray-400 text-black' : 
                                index === 2 ? 'bg-orange-600 text-white' : 'bg-gray-700'
                            }">
                                ${index + 1}
                            </div>
                        </td>
                        <td class="p-3 font-semibold">${user.username}</td>
                        <td class="p-3">
                            <div class="text-blue-300">${user.email}</div>
                            <div class="text-xs text-gray-400">Copy: <button onclick="copyToClipboard('${user.email}')" class="text-green-400 hover:text-green-300">üìã</button></div>
                        </td>
                        <td class="p-3">${user.telegram || '-'}</td>
                        <td class="p-3 font-bold text-yellow-400">${user.totalPoints}</td>
                        <td class="p-3 text-blue-400">${user.taskPoints}</td>
                        <td class="p-3 text-green-400">${user.referralPoints}</td>
                        <td class="p-3">
                            <span class="bg-green-600 px-2 py-1 rounded text-sm">${user.referralCount}</span>
                        </td>
                        <td class="p-3">
                            <span class="bg-blue-600 px-2 py-1 rounded text-sm">${user.completedTasks.length}</span>
                        </td>
                        <td class="p-3">
                            ${user.pendingTasks && user.pendingTasks.length > 0 ? 
                                `<span class="bg-orange-600 px-2 py-1 rounded text-sm">${user.pendingTasks.length}</span>` : 
                                '<span class="text-gray-400">-</span>'
                            }
                        </td>
                        <td class="p-3 text-sm text-gray-300">
                            ${new Date(user.createdAt).toLocaleDateString('en-US')}
                        </td>
                        <td class="p-3">
                            <div class="flex gap-2">
                                <button onclick="viewUserDetails('${user.username}')" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                                    View
                                </button>
                                ${user.pendingTasks && user.pendingTasks.length > 0 ? 
                                    `<button onclick="showPendingVerifications()" class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-sm">
                                        Review
                                    </button>` : 
                                    ''
                                }
                            </div>
                        </td>
                    </tr>
                `;
                usersTable.innerHTML += userRow;
            });
        }

        async function showPendingVerifications() {
            try {
                const response = await fetch(`${ADMIN_URL}/pending-verifications`);
                const data = await response.json();
                
                if (data.success) {
                    const pendingList = document.getElementById('pendingVerificationsList');
                    pendingList.innerHTML = '';

                    if (data.pendingVerifications.length === 0) {
                        pendingList.innerHTML = '<div class="text-center text-gray-400 py-8">No pending verifications</div>';
                    } else {
                        data.pendingVerifications.forEach(verification => {
                            const verificationHTML = `
                                <div class="verification-item rounded-lg p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <h4 class="font-bold text-lg">${verification.taskTitle}</h4>
                                            <div class="text-sm text-gray-300">
                                                User: <span class="text-blue-300">${verification.username}</span> | 
                                                Email: <span class="text-green-300">${verification.email}</span>
                                            </div>
                                            <div class="text-sm text-gray-400">
                                                Submitted: ${new Date(verification.submittedAt).toLocaleString()}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xl font-bold text-yellow-400">+${verification.points} pts</div>
                                            <div class="text-sm text-gray-400">Task: ${verification.taskId}</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="approveTask('${verification.username}', '${verification.taskId}')" 
                                                class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex-1">
                                            ‚úÖ Approve & Award Points
                                        </button>
                                        <button onclick="rejectTask('${verification.username}', '${verification.taskId}')" 
                                                class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg flex-1">
                                            ‚ùå Reject Task
                                        </button>
                                        <button onclick="viewUserDetails('${verification.username}')" 
                                                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">
                                            üë§ View User
                                        </button>
                                    </div>
                                </div>
                            `;
                            pendingList.innerHTML += verificationHTML;
                        });
                    }

                    // Show pending section, hide users section
                    document.getElementById('pendingSection').classList.remove('hidden');
                    document.getElementById('usersSection').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading pending verifications:', error);
                alert('Error loading pending verifications');
            }
        }

        function showAllUsers() {
            document.getElementById('pendingSection').classList.add('hidden');
            document.getElementById('usersSection').classList.remove('hidden');
        }

        async function approveTask(username, taskId) {
            if (!confirm(`Approve task for ${username} and award points?`)) return;

            try {
                const response = await fetch(`${ADMIN_URL}/approve-task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, taskId })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Task approved! ${username} received points.`);
                    loadData();
                    showPendingVerifications();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error approving task:', error);
                alert('Error approving task');
            }
        }

        async function rejectTask(username, taskId) {
            const reason = prompt('Enter reason for rejection:');
            if (!reason) return;

            try {
                const response = await fetch(`${ADMIN_URL}/reject-task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, taskId, reason })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(`‚ùå Task rejected. User notified.`);
                    loadData();
                    showPendingVerifications();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error rejecting task:', error);
                alert('Error rejecting task');
            }
        }

        async function viewUserDetails(username) {
            try {
                const response = await fetch(`${ADMIN_URL}/data`);
                const data = await response.json();
                
                if (data.success) {
                    const user = data.data.users.find(u => u.username === username);
                    if (user) {
                        document.getElementById('modalTitle').textContent = `User: ${user.username}`;
                        
                        const modalContent = `
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-gray-400 text-sm">Email</label>
                                        <div class="text-blue-300">${user.email}</div>
                                    </div>
                                    <div>
                                        <label class="text-gray-400 text-sm">Telegram</label>
                                        <div>${user.telegram || 'Not provided'}</div>
                                    </div>
                                    <div>
                                        <label class="text-gray-400 text-sm">Referral Code</label>
                                        <div class="font-mono">${user.referralCode}</div>
                                    </div>
                                    <div>
                                        <label class="text-gray-400 text-sm">Total Points</label>
                                        <div class="text-yellow-400 font-bold text-xl">${user.totalPoints}</div>
                                    </div>
                                </div>

                                <div class="border-t border-gray-600 pt-4">
                                    <h4 class="font-bold mb-2">üìä Points Breakdown</h4>
                                    <div class="grid grid-cols-3 gap-2 text-sm">
                                        <div class="text-center p-2 bg-blue-600 rounded">
                                            <div>Task Points</div>
                                            <div class="font-bold">${user.taskPoints}</div>
                                        </div>
                                        <div class="text-center p-2 bg-green-600 rounded">
                                            <div>Referral Points</div>
                                            <div class="font-bold">${user.referralPoints}</div>
                                        </div>
                                        <div class="text-center p-2 bg-yellow-600 rounded">
                                            <div>Referrals</div>
                                            <div class="font-bold">${user.referralCount}</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="border-t border-gray-600 pt-4">
                                    <h4 class="font-bold mb-2">‚úÖ Completed Tasks (${user.completedTasks.length})</h4>
                                    ${user.completedTasks.length > 0 ? 
                                        user.completedTasks.map(task => `
                                            <div class="flex justify-between items-center p-2 bg-green-900 rounded mb-1">
                                                <span>${getTaskTitle(task.taskId)}</span>
                                                <span class="text-yellow-400">+${task.points} pts</span>
                                            </div>
                                        `).join('') : 
                                        '<div class="text-gray-400 text-center py-2">No completed tasks</div>'
                                    }
                                </div>

                                ${user.pendingTasks && user.pendingTasks.length > 0 ? `
                                <div class="border-t border-gray-600 pt-4">
                                    <h4 class="font-bold mb-2">‚è≥ Pending Tasks (${user.pendingTasks.length})</h4>
                                    ${user.pendingTasks.map(task => `
                                        <div class="flex justify-between items-center p-2 bg-orange-900 rounded mb-1">
                                            <span>${getTaskTitle(task.taskId)}</span>
                                            <span class="text-yellow-400">+${task.points} pts</span>
                                            <div class="flex gap-1">
                                                <button onclick="approveTask('${user.username}', '${task.taskId}')" 
                                                        class="bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs">
                                                    Approve
                                                </button>
                                                <button onclick="rejectTask('${user.username}', '${task.taskId}')" 
                                                        class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">
                                                    Reject
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}

                                <div class="border-t border-gray-600 pt-4">
                                    <h4 class="font-bold mb-2">üìÖ Account Info</h4>
                                    <div class="text-sm text-gray-300">
                                        <div>Registered: ${new Date(user.createdAt).toLocaleString()}</div>
                                        <div>Last Active: ${new Date(user.lastActive).toLocaleString()}</div>
                                        ${user.referredBy ? `<div>Referred by: ${user.referredBy}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;

                        document.getElementById('modalContent').innerHTML = modalContent;
                        document.getElementById('userModal').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading user details:', error);
                alert('Error loading user details');
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Email copied to clipboard: ' + text);
            });
        }

        function getTaskTitle(taskId) {
            const tasks = {
                'twitter_follow': 'Follow on X (Twitter)',
                'twitter_post': 'Post on X',
                'telegram_join': 'Join Telegram'
            };
            return tasks[taskId] || taskId;
        }

        // Load data on page load and every 30 seconds
        loadData();
        setInterval(loadData, 30000);

        // Close modal when clicking outside
        document.getElementById('userModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUserModal();
            }
        });
    </script>
</body>
</html>
