<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRYPTA - Referral Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #581c87, #1e3a8a, #000);
            min-height: 100vh;
        }
        .glow {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
        }
        .task-link {
            transition: all 0.3s ease;
        }
        .task-link:hover {
            transform: translateY(-2px);
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body class="text-white">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-black bg-opacity-50 backdrop-blur-md border-b border-purple-500/30">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-500 rounded-lg flex items-center justify-center font-bold text-xl">
                        C
                    </div>
                    <h1 class="text-2xl font-bold">CRYPTA</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button 
                        onclick="showLoginForm()"
                        id="loginBtn"
                        class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold transition-all"
                    >
                        Accedi
                    </button>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Total Points</div>
                        <div class="text-2xl font-bold text-purple-400" id="totalPoints">0</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Login/Register -->
        <div id="loginSection" class="container mx-auto px-4 py-20 max-w-md">
            <div class="bg-gradient-to-br from-purple-600/20 to-blue-600/20 backdrop-blur-sm rounded-xl p-8 border border-purple-500/30 glow">
                <h2 class="text-3xl font-bold mb-6 text-center">Benvenuto in CRYPTA</h2>
                <p class="text-gray-300 text-center mb-6 text-sm">
                    Inserisci i tuoi dati per ricevere i premi!
                </p>
                <div class="space-y-4">
                    <input 
                        type="text" 
                        id="usernameInput" 
                        placeholder="Username (obbligatorio)"
                        class="w-full bg-black/50 border border-purple-500/50 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-purple-400"
                    />
                    <input 
                        type="email" 
                        id="emailInput" 
                        placeholder="Email (obbligatorio per i premi)"
                        class="w-full bg-black/50 border border-purple-500/50 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-purple-400"
                    />
                    <input 
                        type="text" 
                        id="telegramInput" 
                        placeholder="Telegram @username (opzionale)"
                        class="w-full bg-black/50 border border-purple-500/50 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-purple-400"
                    />
                    <input 
                        type="text" 
                        id="referralInput" 
                        placeholder="Codice referral (opzionale)"
                        class="w-full bg-black/50 border border-purple-500/50 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-purple-400"
                    />
                    <button 
                        onclick="register()"
                        class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-semibold transition-all"
                    >
                        Inizia a Guadagnare
                    </button>
                </div>
                <div class="mt-4 text-center">
                    <button 
                        onclick="showLoginForm()"
                        class="text-blue-400 hover:text-blue-300 text-sm"
                    >
                        Hai già un account? Accedi qui
                    </button>
                </div>
                <div class="mt-4 text-center text-xs text-gray-400">
                    <p>La tua email sarà utilizzata solo per contattarti e consegnare i premi</p>
                </div>
            </div>
        </div>

        <!-- Login per utenti esistenti -->
        <div id="loginExistingSection" class="container mx-auto px-4 py-20 max-w-md hidden">
            <div class="bg-gradient-to-br from-blue-600/20 to-green-600/20 backdrop-blur-sm rounded-xl p-8 border border-blue-500/30 glow">
                <h2 class="text-2xl font-bold mb-6 text-center">Accedi al Tuo Account</h2>
                <div class="space-y-4">
                    <input 
                        type="text" 
                        id="loginUsernameInput" 
                        placeholder="Username"
                        class="w-full bg-black/50 border border-blue-500/50 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400"
                    />
                    <div class="text-center text-gray-300 text-sm">oppure</div>
                    <input 
                        type="email" 
                        id="loginEmailInput" 
                        placeholder="Email"
                        class="w-full bg-black/50 border border-blue-500/50 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400"
                    />
                    <button 
                        onclick="loginExistingUser()"
                        class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold transition-all"
                    >
                        Accedi al Account
                    </button>
                    <button 
                        onclick="showRegisterForm()"
                        class="w-full bg-gray-600 hover:bg-gray-700 py-3 rounded-lg font-semibold transition-all"
                    >
                        Nuovo Utente? Registrati
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Dashboard (hidden initially) -->
        <div id="dashboardSection" class="container mx-auto px-4 py-8 max-w-4xl hidden">
            <!-- User Info -->
            <div class="bg-gradient-to-br from-purple-600/10 to-blue-600/10 backdrop-blur-sm rounded-xl p-6 border border-purple-500/30 mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold">👋 Benvenuto, <span id="userName" class="text-purple-400"></span>!</h2>
                        <p class="text-gray-300 text-sm mt-1">
                            Email: <span id="userEmail" class="text-green-400"></span>
                            <span id="userTelegram" class="ml-3"></span>
                        </p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Il tuo codice</div>
                        <div class="text-lg font-bold text-yellow-400" id="userReferralCode">-</div>
                        <button 
                            onclick="logout()"
                            class="text-xs text-gray-400 hover:text-gray-300 mt-1"
                        >
                            Esci
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid md:grid-cols-3 gap-4 mb-8">
                <div class="bg-gradient-to-br from-purple-600/20 to-purple-800/20 backdrop-blur-sm rounded-xl p-6 border border-purple-500/30">
                    <div class="text-gray-300 mb-2">Task Points</div>
                    <div class="text-3xl font-bold" id="taskPoints">0</div>
                </div>
                <div class="bg-gradient-to-br from-blue-600/20 to-blue-800/20 backdrop-blur-sm rounded-xl p-6 border border-blue-500/30">
                    <div class="text-gray-300 mb-2">Referrals</div>
                    <div class="text-3xl font-bold" id="referralCount">0</div>
                </div>
                <div class="bg-gradient-to-br from-green-600/20 to-green-800/20 backdrop-blur-sm rounded-xl p-6 border border-green-500/30">
                    <div class="text-gray-300 mb-2">Referral Points</div>
                    <div class="text-3xl font-bold" id="referralPoints">0</div>
                    <div class="text-xs text-gray-400 mt-1">150 pts per referral</div>
                </div>
            </div>

            <!-- Referral Link -->
            <div class="bg-gradient-to-br from-purple-600/10 to-blue-600/10 backdrop-blur-sm rounded-xl p-6 border border-purple-500/30 mb-8">
                <h2 class="text-xl font-bold mb-4">🔗 Your Referral Link</h2>
                <p class="text-gray-300 mb-4 text-sm">
                    Share your link and earn <span class="text-green-400 font-bold">150 points</span> for each person who joins!
                </p>
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="referralLink"
                        readonly
                        class="flex-1 bg-black/50 border border-purple-500/50 rounded-lg px-4 py-3 text-sm"
                    />
                    <button 
                        onclick="copyLink()"
                        class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-semibold transition-all"
                        id="copyBtn"
                    >
                        Copy
                    </button>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="bg-gradient-to-br from-gray-900/50 to-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700/50 mb-8">
                <h2 class="text-2xl font-bold mb-6">🏆 Complete Tasks & Earn Points</h2>
                <div id="tasksList" class="space-y-4">
                    <!-- Tasks will be injected here -->
                </div>

                <!-- Progress Bar -->
                <div class="mt-8 pt-6 border-t border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400">Progress</span>
                        <span class="text-sm font-semibold" id="progressText">0 / 3 tasks completed</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div 
                            id="progressBar"
                            class="bg-gradient-to-r from-purple-500 to-blue-500 h-3 rounded-full transition-all duration-500"
                            style="width: 0%"
                        ></div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard -->
            <div class="bg-gradient-to-br from-yellow-600/10 to-orange-600/10 backdrop-blur-sm rounded-xl p-6 border border-yellow-500/30">
                <h3 class="text-xl font-bold mb-4">🏅 Top Referrers</h3>
                <div id="leaderboard" class="space-y-3">
                    <!-- Leaderboard will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/referral';
        let currentUser = null;

        const tasks = [
            { 
                id: 'twitter_follow', 
                title: 'Segui CRYPTA VPN su X (Twitter)', 
                points: 50, 
                icon: '🐦',
                link: 'https://x.com/cryptavpn?s=21',
                description: 'Clicca qui per seguire il nostro profilo Twitter',
                buttonText: 'Segui su X'
            },
            { 
                id: 'twitter_post', 
                title: 'Posta e taggaci su X', 
                points: 100, 
                icon: '📱',
                link: 'https://x.com/intent/tweet?text=Scopri%20CRYPTA%20VPN%20-%20La%20privacy%20è%20un%20diritto%20fundamentale!%20%40cryptavpn%20%F0%9F%94%92%EF%B8%8F',
                description: 'Crea un post taggando @cryptavpn',
                buttonText: 'Posta su X'
            },
            { 
                id: 'telegram_join', 
                title: 'Unisciti al canale Telegram', 
                points: 75, 
                icon: '✈️',
                link: 'https://t.me/cryptacommunityvpn',
                description: 'Unisciti alla nostra community Telegram',
                buttonText: 'Unisciti a Telegram'
            }
        ];

        // Funzioni per la navigazione
        function showLoginForm() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('loginExistingSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            clearLoginForms();
        }

        function showRegisterForm() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('loginExistingSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            clearLoginForms();
        }

        function clearLoginForms() {
            document.getElementById('loginUsernameInput').value = '';
            document.getElementById('loginEmailInput').value = '';
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('loginExistingSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            clearAllForms();
        }

        function clearAllForms() {
            document.getElementById('usernameInput').value = '';
            document.getElementById('emailInput').value = '';
            document.getElementById('telegramInput').value = '';
            document.getElementById('referralInput').value = '';
            clearLoginForms();
        }

        // Registrazione nuovo utente
        async function register() {
            const username = document.getElementById('usernameInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();
            const telegram = document.getElementById('telegramInput').value.trim();
            const referredBy = document.getElementById('referralInput').value.trim();

            if (!username) {
                alert('Inserisci un username!');
                return;
            }

            if (!email) {
                alert('Inserisci la tua email per ricevere i premi!');
                return;
            }

            if (!email.includes('@') || !email.includes('.')) {
                alert('Inserisci un\'email valida!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/user/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, telegram, referredBy })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('loginExistingSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    loadDashboard();
                } else {
                    if (data.suggestion) {
                        alert('Errore: ' + data.error + '\n' + data.suggestion);
                    } else {
                        alert('Errore: ' + data.error);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Errore di connessione al server!');
            }
        }

        // Login utente esistente
        async function loginExistingUser() {
            const username = document.getElementById('loginUsernameInput').value.trim();
            const email = document.getElementById('loginEmailInput').value.trim();

            if (!username && !email) {
                alert('Inserisci username o email!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/user/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('loginExistingSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    loadDashboard();
                } else {
                    alert('Errore: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Errore di connessione al server!');
            }
        }

        // Carica la dashboard
        function loadDashboard() {
            // Update user info
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userReferralCode').textContent = currentUser.referralCode;
            
            if (currentUser.telegram) {
                document.getElementById('userTelegram').innerHTML = `Telegram: <span class="text-blue-400">${currentUser.telegram}</span>`;
            } else {
                document.getElementById('userTelegram').innerHTML = '';
            }

            // Update stats
            document.getElementById('totalPoints').textContent = currentUser.points || 0;
            document.getElementById('taskPoints').textContent = calculateTaskPoints();
            document.getElementById('referralCount').textContent = currentUser.referralCount || 0;
            document.getElementById('referralPoints').textContent = (currentUser.referralCount || 0) * 150;
            document.getElementById('referralLink').value = `${window.location.origin}?ref=${currentUser.referralCode}`;

            // Load tasks
            renderTasks();
            
            // Load leaderboard
            loadLeaderboard();
        }

        function calculateTaskPoints() {
            return (currentUser.completedTasks || []).reduce((sum, task) => sum + task.points, 0);
        }

        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';

            tasks.forEach(task => {
                const isCompleted = (currentUser.completedTasks || []).some(t => t.taskId === task.id);
                
                const taskHTML = `
                    <div class="bg-gradient-to-r ${isCompleted ? 'from-green-900/30 to-green-800/30 border-green-500/50' : 'from-gray-800/50 to-gray-900/50 border-gray-600/50'} border rounded-xl p-5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center ${isCompleted ? 'bg-green-500/20' : 'bg-purple-500/20'} text-2xl">
                                    ${task.icon}
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-lg">${task.title}</h3>
                                    <p class="text-gray-300 text-sm mt-1">${task.description}</p>
                                    <div class="flex items-center gap-3 mt-2">
                                        <span class="text-yellow-400 font-bold">+${task.points} points</span>
                                        ${isCompleted ? '<span class="text-green-400 text-sm">✓ Completed</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <a 
                                    href="${task.link}" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-all task-link text-center text-sm"
                                >
                                    ${task.buttonText}
                                </a>
                                <button
                                    onclick="completeTask('${task.id}', ${task.points}, this)"
                                    ${isCompleted ? 'disabled' : ''}
                                    class="complete-task-btn px-4 py-2 rounded-lg font-semibold transition-all text-sm ${isCompleted ? 'bg-green-600/50 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700'}"
                                    data-taskid="${task.id}"
                                >
                                    ${isCompleted ? 'Completato' : 'Verifica Task'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                tasksList.innerHTML += taskHTML;
            });

            updateProgress();
        }

        function updateProgress() {
            const completed = (currentUser.completedTasks || []).length;
            const total = tasks.length;
            const percentage = (completed / total) * 100;

            document.getElementById('progressText').textContent = `${completed} / ${total} tasks completed`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }

        // Verifica automatica task
        async function completeTask(taskId, points, button) {
            try {
                // Mostra loading
                button.disabled = true;
                button.innerHTML = '⏳ Verificando...';
                button.classList.add('loading');

                const response = await fetch(`${API_URL}/task/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        taskId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    loadDashboard();
                    alert(data.message);
                } else {
                    alert(data.error);
                    button.disabled = false;
                    button.innerHTML = 'Verifica Task';
                    button.classList.remove('loading');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Errore nella verifica della task!');
                button.disabled = false;
                button.innerHTML = 'Verifica Task';
                button.classList.remove('loading');
            }
        }

        async function loadLeaderboard() {
            try {
                const response = await fetch(`${API_URL}/leaderboard?limit=10`);
                const data = await response.json();
                
                if (data.success) {
                    const leaderboard = document.getElementById('leaderboard');
                    leaderboard.innerHTML = '';

                    data.leaderboard.forEach(entry => {
                        const medals = ['🥇', '🥈', '🥉'];
                        const medal = entry.rank <= 3 ? medals[entry.rank - 1] : entry.rank;
                        const isCurrentUser = entry.username === currentUser.username;

                        const entryHTML = `
                            <div class="flex items-center justify-between bg-black/30 rounded-lg p-3 ${isCurrentUser ? 'border-2 border-purple-500' : ''}">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">
                                        ${medal}
                                    </div>
                                    <span class="${isCurrentUser ? 'font-bold text-purple-400' : ''}">${entry.username}</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold">${entry.points} pts</div>
                                    <div class="text-xs text-gray-400">${entry.referrals} referrals</div>
                                </div>
                            </div>
                        `;
                        leaderboard.innerHTML += entryHTML;
                    });
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        function copyLink() {
            const link = document.getElementById('referralLink');
            link.select();
            document.execCommand('copy');
            
            const btn = document.getElementById('copyBtn');
            btn.textContent = '✓ Copied!';
            setTimeout(() => btn.textContent = 'Copy', 2000);
        }

        // Auto-fill referral code from URL
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                document.getElementById('referralInput').value = refCode;
            }
        });
    </script>
</body>
</html>
